# Use Ubuntu 22.04 as base (matches JetPack 6.2.1 environment)
# This will use the ARM64 version when built on Jetson
FROM ubuntu:22.04

# Build arguments
ARG BUILD_JOBS=6

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
RUN apt-get update && apt-get install -y \
    git \
    cmake \
    g++ \
    python3.10 \
    python3.10-dev \
    libv4l-dev \
    v4l-utils \
    libopencv-dev \
    libgl1-mesa-dev libglfw3-dev \
    doxygen graphviz \
    libxinerama-dev \
    libxcursor-dev \
    libxi-dev \
    libxrandr-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Copy the local libs folder to the workspace
COPY libs /workspace/libs

# Copy local repo code (excluding build, reo/build, scripts)
COPY local_code /workspace/repo

# Set working directory to the local code
WORKDIR /workspace/repo

RUN

# Create build directory
RUN mkdir -p build

# Set working directory to build
WORKDIR /workspace/repo/build

# Configure with CMake - output will be visible during docker build
RUN cmake -DBUILD_TESTING=ON -DNVIDIA=1 -DWITH_NETWORK=OFF -DWITH_SUBMODULES=OFF -DCMAKE_BUILD_TYPE=Release ..

# Build the project with verbose output
#RUN cmake --build . -j ${BUILD_JOBS} --verbose
RUN make -j${BUILD_JOBS}

# Default command to show build succeeded
CMD ["echo", "Build completed successfully!"]
