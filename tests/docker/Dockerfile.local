# Use Ubuntu 22.04 as base (compatible with multiple ARM64 platforms)
# - NVIDIA Jetson (JetPack 6.2.1)
# - Raspberry Pi 4/5 (64-bit)
# - Generic ARM64 systems
FROM ubuntu:22.04

# Build arguments
ARG BUILD_JOBS=6

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies (platform-agnostic)
RUN apt-get update && apt-get install -y \
    cmake \
    g++ \
    python3.10 \
    python3.10-dev \
    libv4l-dev \
    v4l-utils \
    googletest \
    libgtest-dev \
    wget \
    git \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Set library paths for ARM64 platforms (Jetson, Raspberry Pi, etc.)
# This path works on both NVIDIA Jetson and Raspberry Pi 64-bit
ENV LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu:/usr/local/lib:${LD_LIBRARY_PATH}

# Set working directory
WORKDIR /workspace

# Copy the local libs folder to the workspace
COPY libs /workspace/libs

# Copy local libaditof code (excluding build, libaditof/build, scripts)
COPY local_code /workspace/libaditof

# Set working directory to the local code
WORKDIR /workspace/libaditof

# Create build directory
RUN mkdir -p build

# Set working directory to build
WORKDIR /workspace/libaditof/build

# Configure with CMake - output will be visible during docker build
RUN cmake -DBUILD_TESTING=ON -DNVIDIA=1 -DWITH_NETWORK=OFF -DWITH_SUBMODULES=OFF ..

# Build the project with verbose output
#RUN cmake --build . -j ${BUILD_JOBS} --verbose
RUN make -j${BUILD_JOBS}

# Default command to show build succeeded
CMD ["echo", "Build completed successfully!"]
